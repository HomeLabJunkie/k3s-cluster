---
- name: Checksum Setup
  run_once: true
  block:
    - name: Get remote checksum
      ansible.builtin.uri:
        url: '{{ k3s_project.release.kubepug.checksum }}'
        return_content: true
      register: checksum
      check_mode: false

    - name: Set sha256 checksum fact
      ansible.builtin.set_fact:
        sha256_checksum: "{{ item.split(' ')[0] }}"
      loop: "{{ checksum.content.split('\n') }}"
      when: item | regex_search(k3s_vars.release.kubepug.file + '$')

- name: Download kubepug archive
  ansible.builtin.get_url:
    url: '{{ k3s_project.release.kubepug.file }}'
    checksum: sha256:{{ sha256_checksum }}
    dest: /tmp
    owner: root
    group: root
    mode: '0644'
  register: result
  delay: 1
  retries: 3
  until: result is not failed
  check_mode: false

- name: Install kubepug binary
  ansible.builtin.unarchive:
    src: /tmp/{{ k3s_vars.release.kubepug.file }}
    dest: '{{ k3s_vars.directory.bin }}'
    owner: root
    group: root
    mode: '0755'
    remote_src: true

- name: Remove kubepug archive
  ansible.builtin.file:
    path: /tmp/{{ k3s_vars.release.kubepug.file }}
    state: absent
  check_mode: false
